description:
    name: lulesh_sample1
    description: A sample LULESH study that downloads, builds, and runs a parameter study of varying problem sizes and iterations.

env:
    variables:
        # DEFAULTS FOR MONTECARLO PGEN EXAMPLE
        SMIN:        10
        SMAX:        30
        TRIALS:      50
        ITER:        100

        OUTPUT_PATH: ./sample_output/lulesh

    labels:
        outfile: $(SIZE.label).$(ITERATIONS.label).log

    dependencies:
      git:
        - name: LULESH
          path: $(OUTPUT_PATH)
          url: https://github.com/LLNL/LULESH.git
          tag: 2.0.3

batch:
    shell: /bin/bash

study:
    - name: make-lulesh
      description: Build the serial version of LULESH.
      run:
          cmd: |
            cd $(LULESH)
            sed -i "" 's/^CXX = $(MPICXX)/CXX = $(SERCXX)/' ./Makefile
            sed -i "" 's/^CXXFLAGS = -g -O3 -fopenmp/#CXXFLAGS = -g -O3 -fopenmp/' ./Makefile
            sed -i "" 's/^#LDFLAGS = -g -O3/LDFLAGS = -g -O3/' ./Makefile
            sed -i "" 's/^LDFLAGS = -g -O3 -fopenmp/#LDFLAGS = -g -O3 -fopenmp/' ./Makefile
            sed -i "" 's/^#CXXFLAGS = -g -O3 -I/CXXFLAGS = -g -O3 -I/' ./Makefile
            make clean
            make
          depends: []

    - name: run-lulesh
      description: Run LULESH.
      run:
          cmd: |
            $(LULESH)/lulesh2.0 -s $(SIZE) -i $(ITERATIONS) -p > $(outfile)
          depends: [make-lulesh]

    - name: test-directory-hashing
      description: Test directory hashing.
      run:
          cmd:
            echo $(VAR1) - $(VAR2) - $(VAR3) - $(VAR4) > $(outfile)

    - name: post-process-lulesh
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Unparameterized step with Parameter Independent dependencies." >> out.log
            echo $(run-lulesh.workspace) >> out.log
            ls $(run-lulesh.workspace) >> out.log
          depends: [run-lulesh_*]

    - name: post-process-lulesh-trials
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Parameterized step that has Parameter Independent dependencies" >> out.log
            echo "TRIAL = $(TRIAL)" >> out.log
            echo $(run-lulesh.workspace) >> out.log
            ls $(run-lulesh.workspace) >> out.log
          depends: [run-lulesh_*]

    - name: post-process-lulesh-size
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Parameterized step that has Parameter Independent dependencies" >> out.log
            echo "SIZE = $(SIZE)" >> out.log
            echo $(run-lulesh.workspace) >> out.log
            ls $(run-lulesh.workspace) | grep $(SIZE.label) >> out.log
          depends: [run-lulesh_*]

global.parameters:
    TRIAL:
        values  : [1, 2, 3, 4, 5, 6, 7, 8, 9]
        label   : TRIAL.%%
    SIZE:
        values  : [10, 10, 10, 20, 20, 20, 30, 30, 30]
        label   : SIZE.%%
    ITERATIONS:
        values  : [10, 20, 30, 10, 20, 30, 10, 20, 30]
        label   : ITER.%%
    VAR1:
        values  : [ 0.3874309076, 0.3585516934, 0.8368954934, 0.3597349116, 0.5010202705, 0.4419715749, 0.3837019747, 0.8251750674, 0.1956225349 ]
        label   : VAR1.%%
    VAR2:
        values  : [ 0.7520078045, 0.1707261687, 0.7296721416, 0.9457194760, 0.2706341815, 0.4635123514, 0.9558881173, 0.9563149111, 0.3519489632 ]
        label   : VAR2.%%
    VAR3:
        values  : [ 0.7187181590, 0.4406243939, 0.8958327389, 0.5439030734, 0.2866535570, 0.4036018283, 0.0712886048, 0.8181983474, 0.2134559003 ]
        label   : VAR3.%%
    VAR4:
        values  : [ 0.5491000152, 0.3920015696, 0.1895291838, 0.2584696455, 0.5731830405, 0.8745953379, 0.6259727671, 0.5499554186, 0.0106668970 ]
        label   : VAR4.%%       
 