####################################
# Description Block (Required)
####################################
# The description block is where the description of the study is placed. This
# section is meant primarily for documentation purposes so that when a
# spcecifcation is passed to other users they can gleam a general understanding
# of what this study is meant to achieve.
#-------------------------------
# Required keys:
#   name - Name of the study
#   description - Description of what this study does.
#-------------------------------
# NOTE: You can add other keys to this block for custom documentation. Maestro
# currently on looks for the required set.
####################################
description:
    name: lulesh_sample1
    description: A sample LULESH study that downloads, builds, and runs a parameter study of varying problem sizes and iterations.

####################################
# Environment Block
####################################
# The environment block is where items describing the study's environment are
# defined. This includes static information that the study needs to know about
# and dependencies that the workflow requires for execution.
#-------------------------------
# NOTE: This block isn't strictly required as a study may not depend on anything.
####################################
env:
    #-------------------------------
    # Variables
    #-------------------------------
    # Static values that the workflow substitutes into steps and are similar in
    # concept to Unix environment variables. These variables are not dependent
    # on values in the environment and so are more portable.

    # NOTE: These values are substituted as static strings meaning that other
    # variables should not used in other variables.
    #-------------------------------
    variables:
        # OUTPUT_PATH is a keyword variable that Maestro looks for in order to
        # set a custom output path for the study workspace. If not specified,
        # OUTPUT_PATH is assumed to be the path where Maestro was launched from.
        OUTPUT_PATH: ./sample_output/lulesh

    #-------------------------------
    # Labels
    #-------------------------------
    # Static values that can contain variables and parameters which, like
    # variables, will be substituted into all steps. Labels are useful for
    # enforcing fixed formatting for output files, or fixed formatting for
    # components of steps which follow fixed formats.
    #-------------------------------
    labels:
        outfile: $(SIZE.label).$(ITERATIONS.label).log

    #-------------------------------
    # Dependencies
    #-------------------------------
    # Dependencies represent external artifacts that should be present before a
    # workflow can run. These are things like acquirable inputs from a directory
    # or a repository such as input files for programs, code, data, etc..

    # NOTE: Currently there are only two types of dependencies:
    # path - verifies the existence of the specified path before execution.
    # git  - clones the specified repository before execution of the study.
    #-------------------------------
    dependencies:
      git:
        - name: LULESH
          path: $(OUTPUT_PATH)
          url: https://github.com/LLNL/LULESH.git

study:
    - name: make-lulesh
      description: Build the serial version of LULESH.
      run:
          cmd: |
            cd $(LULESH)
            sed -i 's/^CXX = $(MPICXX)/CXX = $(SERCXX)/' ./Makefile
            sed -i 's/^CXXFLAGS = -g -O3 -fopenmp/#CXXFLAGS = -g -O3 -fopenmp/' ./Makefile
            sed -i 's/^#LDFLAGS = -g -O3/LDFLAGS = -g -O3/' ./Makefile
            sed -i 's/^LDFLAGS = -g -O3 -fopenmp/#LDFLAGS = -g -O3 -fopenmp/' ./Makefile
            sed -i 's/^#CXXFLAGS = -g -O3 -I/CXXFLAGS = -g -O3 -I/' ./Makefile
            make clean
            make
          depends: []

    - name: run-lulesh
      description: Run LULESH.
      run:
          cmd: |
            $(LULESH)/lulesh2.0 -s $(SIZE) -i $(ITERATIONS) -p > $(outfile)
          depends: [make-lulesh]

    - name: post-process-lulesh
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Unparameterized step with Parameter Independent dependencies." >> out.log
            echo $(run-lulesh.workspace) > out.log
            ls $(run-lulesh.workspace) > ls.log
          depends: [run-lulesh_*]

    - name: post-process-lulesh-trials
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Parameterized step that has Parameter Independent dependencies" >> out.log
            echo "TRIAL = $(TRIAL)" >> out.log
            echo $(run-lulesh.workspace) >> out.log
            ls $(run-lulesh.workspace) > out.log
          depends: [run-lulesh_*]

    - name: post-process-lulesh-size
      description: Post process all LULESH results.
      run:
          cmd: |
            echo "Parameterized step that has Parameter Independent dependencies" >> out.log
            echo "SIZE = $(SIZE)" >> out.log
            echo $(run-lulesh.workspace) >> out.log
            ls $(run-lulesh.workspace) | grep $(SIZE.label) >> out.log
          depends: [run-lulesh_*]

global.parameters:
    TRIAL:
        values  : [1, 2, 3, 4, 5, 6, 7, 8, 9]
        label   : TRIAL.%%
    SIZE:
        values  : [10, 10, 10, 20, 20, 20, 30, 30, 30]
        label   : SIZE.%%
    ITERATIONS:
        values  : [10, 20, 30, 10, 20, 30, 10, 20, 30]
        label   : ITER.%%
